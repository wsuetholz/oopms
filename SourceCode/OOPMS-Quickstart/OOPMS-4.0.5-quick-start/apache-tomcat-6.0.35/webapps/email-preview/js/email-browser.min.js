var jasig=jasig||{};(function(E,F){var C=function(W,X){B(W);var R=parseInt(E(X).attr("messageNum"));var Z=K(W,R);if(W.options.markMessagesAsRead&&E(X).hasClass("unread")){var Y=false;for(var V in W.cache){var U=W.cache[V];for(var a in U){var O=U[a];for(var Q in O){var P=O[Q];if(P.messageNumber===R){P.unread=false;Y=true;break}}if(Y){break}}if(Y){break}}W.pager.refreshView();var S=parseInt(W.locate("unreadMessageCount").html());if(S&&S>0){W.locate("unreadMessageCount").html(S-1)}}var T=Z.content.html?Z.content.contentString:"<pre>"+Z.content.contentString+"</pre>";E(".message-content").html(T);E(".email-message .subject").html(Z.subject);E(".email-message .sender").html(Z.sender);E(".email-message .sentDate").html(Z.sentDateString);E(".email-message .message-uid").val(Z.uid);if(W.options.markMessagesAsRead||!Z.unread){W.locate("markMessageReadButton").hide();W.locate("markMessageUnreadButton").show()}else{W.locate("markMessageReadButton").show();W.locate("markMessageUnreadButton").hide()}J(W);return false};var H={};var I="false";var A=function(S,T,Q,P,O){if(S.cache[T]&&S.cache[T][Q]){return S.cache[T][Q]}E.ajax({url:S.options.accountSummaryUrl,async:false,data:{pageStart:T,numberOfMessages:Q,forceRefresh:I},type:"POST",dataType:"json",success:function(U){if(U.errorMessage!=null){M(S,900,U.errorMessage)}I="false";H=U},error:function(V,W,U){M(S,V.status)}});var R=H.accountSummary?H.accountSummary.messages:[];S.cache[T]=S.cache[T]||[];S.cache[T][Q]=R;return R};var G=function(O){return function(S,R,Q,P){return A(O,S,R,Q,P)}};var K=function(Q,O){var P;E.ajax({url:Q.options.messageUrl,async:false,data:{messageNum:O},type:"POST",dataType:"json",success:function(R){if(R.errorMessage!=null){M(Q,900,R.errorMessage)}P=R.message},error:function(S,T,R){M(Q,S.status)}});return P};var D=function(O){O.locate("loadingMessage").hide();O.locate("emailMessage").hide();O.locate("errorMessage").hide();O.locate("emailList").show()};var B=function(O){O.locate("emailList").hide();O.locate("emailMessage").hide();O.locate("errorMessage").hide();O.locate("loadingMessage").show()};var J=function(O){O.locate("loadingMessage").hide();O.locate("emailList").hide();O.locate("errorMessage").hide();O.locate("emailMessage").show()};var M=function(R,P,Q){R.locate("loadingMessage").hide();R.locate("emailList").hide();R.locate("emailMessage").hide();var O=R.options.jsErrorMessages[P]||R.options.jsErrorMessages["default"];if(Q){O+="<br/>"+Q}R.locate("errorText").html(P+": "+O);R.locate("errorMessage").show()};var N=function(O,Q){var P="";if(Q.unread){P+=" unread"}if(!Q.unread){P+=" portlet-section-alternate"}if(Q.answered){P+=" answered"}if(Q.deleted){P+=" deleted"}if(Q.multipart){P+=" attached"}return P};var L=function(P,O){that.locate("emailRow").each(function(Q,R){if(R.find(options.selectors.selectMessage).attr("checked")){R.remove()}})};jasig.EmailBrowser=function(P,R){var S=F.initView("jasig.EmailBrowser",P,R);S.cache=[];B(S);var O={batchSize:S.options.batchSize,pagerOptions:{columnDefs:[{key:"select",valuebinding:"*.select",components:function(W,V){return{markup:'<input type="checkbox" class="select-message" name="selectMessage" value="${*.uid}"/>',decorators:[{attrs:{messageNum:"${*.messageNumber}"}},{type:"addClass",classes:N(V,W)}]}}},{key:"flags",valuebinding:"*.answered",components:function(W,V){return{decorators:[{type:"addClass",classes:N(V,W)}]}}},{key:"attachments",valuebinding:"*.multipart",components:function(W,V){return{decorators:[{type:"addClass",classes:N(V,W)}]}}},{key:"subject",valuebinding:"*.subject",components:function(W,V){return{markup:'<a href="javascript:;">${*.subject}</a>',decorators:[{attrs:{messageNum:"${*.messageNumber}"}},{type:"jQuery",func:"click",args:function(){C(S,this)}},{type:"addClass",classes:N(V,W)}]}}},{key:"sender",valuebinding:"*.senderName",components:function(W,V){return{value:"${*.senderName}",decorators:[{type:"addClass",classes:N(V,W)}]}}},{key:"sentDate",valuebinding:"*.sentDateString",components:function(W,V){return{value:"${*.sentDateString}",decorators:[{type:"addClass",classes:N(V,W)}]}}}],bodyRenderer:{type:"fluid.pager.selfRender",options:{selectors:{root:"table"},row:"row:"}},pagerBar:{type:"fluid.pager.pagerBar",options:{pageList:{type:"fluid.pager.renderedPageList",options:{linkBody:"a",pageStrategy:F.pager.gappedPageStrategy(3,1)}}}},model:{pageSize:S.options.pageSize},listeners:S.options.listeners},dataFunction:G(S),dataLengthFunction:function(){return H.accountSummary?H.accountSummary.totalMessageCount:0}};S.pager=unicon.batchedpager(S.locate("emailList"),O);if(H.accountSummary){S.refresh=function(){B(S);I="true";S.cache=[];S.pager.refreshView();S.locate("unreadMessageCount").html(H.accountSummary.unreadMessageCount);D(S)};var U=function(W){B(S);var V={url:R.deleteUrl,type:"POST",data:W,dataType:"json",error:function(X,Z,Y){M(S,X.status)},success:function(X){if(X.errorMessage!=null){M(S,900,X.errorMessage)}S.refresh()}};E.ajax(V)};var T=function(W,X){B(S);W.push({name:"seenValue",value:X});var V={url:R.toggleSeenUrl,type:"POST",data:W,dataType:"json",error:function(Y,a,Z){M(S,Y.status)},success:function(Y){if(Y.errorMessage!=null){M(S,900,Y.errorMessage)}S.refresh()}};E.ajax(V)};S.deleteSelectedMessages=function(){if(S.locate("emailRow").find("input[checked='true']").size()===0){alert("No Messages Selected.");return }if(confirm("Delete Selected Messages?")){U(S.locate("inboxForm").serializeArray())}};S.deleteShownMessage=function(){if(confirm("Delete This Message?")){U(S.locate("messageForm").serializeArray())}};S.toggleSelectAll=function(){var V=E(this).attr("checked");S.locate("selectMessage").attr("checked",V)};S.locate("refreshLink").click(S.refresh);if(H.accountSummary.deleteSupported){S.locate("deleteMessagesLink").click(S.deleteSelectedMessages);S.locate("deleteMessageButton").click(S.deleteShownMessage)}else{var Q=S.locate("deleteMessagesLink");Q.find("span").html("Delete Not Available");Q.find("span").addClass("fl-text-silver");Q.attr("title","The delete feature is not supported by this mail store")}S.locate("returnLink").click(function(){D(S)});S.locate("markMessageReadButton").click(function(){T(S.locate("messageForm").serializeArray(),"true")});S.locate("markMessageUnreadButton").click(function(){T(S.locate("messageForm").serializeArray(),"false")});S.locate("inboxLink").attr("href",H.inboxUrl);S.locate("selectAll").live("click",S.toggleSelectAll);S.locate("unreadMessageCount").html(H.accountSummary.unreadMessageCount);D(S)}return S};F.defaults("jasig.EmailBrowser",{accountSummaryUrl:null,messageUrl:null,deleteUrl:null,toggleSeenUrl:null,pageSize:10,batchSize:20,selectors:{refreshLink:".refresh-link",deleteMessagesLink:".delete-link",returnLink:".return-link",inboxForm:"form[name='inboxForm']",messageForm:"form[name='messageForm']",deleteMessageButton:".delete-message-button",markMessageReadButton:".mark-read-button",markMessageUnreadButton:".mark-unread-button",timestamp:"input[name='timestamp']",selectAll:".select-all",selectMessage:".select-message",emailList:".email-list",emailRow:".email-row",emailMessage:".email-message",loadingMessage:".loading-message",errorMessage:".error-message",errorText:".error-message #error-text",unreadMessageCount:".unread-message-count",inboxLink:".inbox-link"},listeners:{},jsErrorMessages:{"default":"Server Error"},markMessagesAsRead:true})})(jQuery,fluid);